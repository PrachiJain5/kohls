(function ($) {
    $.fn.tiles = function (options) {
        var set = $.extend({
            'show': 5,
            'speed': 300,
            'newWindow': false,
            'minimumLength':2,
            'mode': 'json',
            'contentLocation': 'js/kohlsContent.json'
        }, options);
        return this.each(function () {
            var tiles_in = {
                tile: [],
                weight: []
            };
            
            $.ajaxSetup({
                async: false
            });
            if (set.mode == 'json') { 
                  $.getJSON(set.contentLocation).done(function (json) {
                    tiles_in = $.extend({}, json);
                });
                 
            }
            if (set.mode == 'static') {
                tiles_in = $.extend({});
            }
            $(this).keyup(function (event) {
                
                if (event.keyCode === 13) {
                    $('#tipue_drop_content').css('display', 'none');               
                    getTipueSearch(0, $(this));
                    return false;
                }
                else {
                    getTiles($(this));
                }
                
            });
           

            function getTiles($obj) {
                $('#tipue_drop_content').html('');
                var cnt = 0;
                var c = 0;

                var score = 0;
                var title, filename;
              

                if ($obj.val()) {
                 
                  var data_length = Object.keys(tiles_in).length;
                  found = [];
                  found_title = [];
                  found_tag = [];

                  var search_matched = 1;
               
                
                  var doc_cookie = document.cookie.split(";");
                  
                  var status ='';

                  for(i = 0; i < doc_cookie.length ; i++){ 
                     var name = doc_cookie[i].split("=")[0].trim(); 
                     if(name=='user_status')
                        status= doc_cookie[i].split("=")[1]; 
                  }
                  

                  for (var i = 0; i < data_length; i++) {

                        var lang = 0;
                        var no_par = $obj.val().replace(/\(|\)/g, "");
                         
                        var pat = new RegExp($obj.val(), 'i');
                      //  var pat = new RegExp(no_par, 'gi');

                        var ln = $obj.val().length;
                        set.newWindow= false;
            
                        //check based on laguage/location/status
                        if(ln >= set.minimumLength){ 
                          if ((tiles_in[i].status.length) == 1) {
                                var stat = 0;
                                if (status === tiles_in[i].status[0]) {
                                    stat++;
                                }

                            } else if ((tiles_in[i].status.length) >= 1) {

                                var stat = 0;
                                
                                for (j = 0; j < tiles_in[i].status.length; j++) {
                                    if (status === tiles_in[i].status[j]) {
                                        stat++;                                    
                                    }
                                }
                            }                            

                            if (stat > 0) {                                   
                                var tags = 0;
                        
                                //looking in titile and text
                                for (var x = 0; x < tiles_in[i].tags.length; x++) {

                                      var no_par_tag = tiles_in[i].tags[x].replace(/\(|\)/g, ""); 

                                      //  var new_tag = new RegExp(no_par_tag, 'gi'); 
                                      if (no_par_tag.search(pat) != -1) {
                                          tags++;
                                          found_tag.push(
                                             {
									             "id":tiles_in[i].id,
                                                 "title": tiles_in[i].title, 
                                                 "filename": tiles_in[i].filename,   
                                                 "icon": tiles_in[i].icon,                                              
                                                 "tag":true
                                             });
                                          break;
                                          
                                      }
                                  }
                                 
                                 
                                 if (tiles_in[i].title.search(pat) != -1 ) { 
                                    found_title.push(                                    
                                    {
                                        "id":tiles_in[i].id,      
                                        "title": tiles_in[i].title, 
                                        "filename": tiles_in[i].filename,
                                        "icon": tiles_in[i].icon,
                                        "tag":false
                                    });
                                }  
                            }
                        }                      
                  }
                   //get unique pages from search results
                   found_new= getUniqueValuesOfKey(found_tag.concat(found_title),'filename');

                  if (ln >= set.minimumLength)
                  {                  
                    for (var arr = 0; arr < found_new.length; arr++) {

                        if (c < set.show) {
                            newWindow = false;

                            if (arr == 0) {
                                var out = '<div class="tipue_drop_box"><div id="tipue_drop_wrapper">';
                                out += "<div class='tipue_suggestion'>Suggestions for &#8220;" + $obj.val() + "&#8221;</div>";
                            }

                            out += '<a id ="'+ found_new[arr].id + '" href="' + found_new[arr].filename + '"';
                            search_matched++;

                            if (found_new[arr].filename.indexOf('http://') === 0 || found_new[arr].filename.indexOf('https://') === 0 || found_new[arr].filename.indexOf('pdf/') === 0 || found_new[arr].filename.indexOf('video/') === 0) {
                            
                                  newWindow=true;
                            }

                            if (newWindow) {
                                out += ' target="_blank"';
                            }
                             if (found_new[arr].icon.trim() === 'pdf') {
                                out += '><div class="tipue_drop_item"><div class="tipue_drop_left pdf"><div class="tipue_drop_right">' + found_new[arr].title + '</div></div></div></a>';
                            } else if (found_new[arr].icon.trim() === 'video') {
                                out += '><div class="tipue_drop_item"><div class="tipue_drop_left video"><div class="tipue_drop_right">' + found_new[arr].title + '</div></div></div></a>';
                            } else {
                                out += '><div class="tipue_drop_item"><div class="tipue_drop_left"><div class="tipue_drop_right">' + found_new[arr].title + '</div></div></div></a>';
                           }


                            
                            

                            c++; 
                        }
                    }  

                   if(found_new.length == 0){
                     var out = '<div class="tipue_drop_box"><div id="tipue_drop_wrapper">';                   

                      out += '<div class="tipue_suggestion">Suggestions for “' + $obj.val() +'”</div><div class="tipue_drop_right" id="tipue_search_warning"> No Results Found. </div>';
                      c++;

                   }

                  }
               
                  if (found_new.length > set.show) {

                      out += '<a href="#" onclick="showFullResults();return false;"><div class="tipue_drop_item more_items"><div class="tipue_drop_left"><div class="tipue_drop_right">View more results ></div></div></div></a>';
                    } 
                   
                    if (c != 0) {
                        out += '</div></div>';
                        $('#tipue_drop_content').html(out);
                        $('#tipue_drop_content').fadeIn(set.speed);
                    }
                     
                } else {
                    $('#tipue_drop_content').fadeOut(set.speed);
                }
                eventTrackSearch();
            }
           
            function getUniqueValuesOfKey(originalArray, prop) {               

                var newArray = [];
                var lookupObject = {};

                for (var i in originalArray) {
                    lookupObject[originalArray[i][prop]] = originalArray[i];
                }

                for (i in lookupObject) {
                    newArray.push(lookupObject[i]);
                }
                return newArray;
            }

            function getTipueSearch(start, replace) {
                var set = $.extend({
                    'show': 7,
                    'newWindow': false,
                    'showfilename': true,
                    'showTitleCount': true,
                    'minimumLength': 2,
                    'descriptiveWords': 25,
                    'highlightTerms': true,
                    'highlightEveryTerm': false,
                    'mode': 'static',
                    'liveDescription': '*',
                    'liveContent': '*',
                    'contentLocation': 'tipuesearch/tipuesearch_content.json',
                    'debug': false

                }, options);

                $('#myDiv').html('');
                // $('#tipue_search_content').hide();
                //  $('#tipue_search_content').html('<div class="tipue_search_spinner"><div class="tipue_search_rect1"></div><div class="tipue_search_rect2"></div><div class="rect3"></div></div>');
                // $('#tipue_search_content').show();

             
                var out = '';
                var results = '';
                var show_replace = false;
                var show_stop = false;
                var standard = true;
                var c = 0;
                found = [];
                found_tag=[];
                found_title=[];

                  var doc_cookie = document.cookie.split(";");

                  var  status;

                  for(var i = 0; i < doc_cookie.length ; i++){
                     var name = doc_cookie[i].split("=")[0].trim(); 
                     if(name=='user_status')
                        status= doc_cookie[i].split("=")[1];
                       
                  }

                  

                var d = $('#tipue_search_input').val().toLowerCase();
                d = $.trim(d);

                if ((d.match("^\"") && d.match("\"$")) || (d.match("^'") && d.match("'$"))) {
                    standard = false;
                }
                //default weight based display

                if (standard) {

                    var d_w = d.split(' ');
                    d = '';
                    for (var i = 0; i < d_w.length; i++) {
                        var a_w = true;
                        
                        if (a_w) {
                            d = d + ' ' + d_w[i];
                        }
                    }
                    d = $.trim(d);
                    d_w = d.split(' ');
                }
                else {

                    d = d.substring(1, d.length - 1);
                }

                if (d.length >= set.minimumLength) {

                    if (standard) {

                        if (replace) { 
                            var d_r = d;
                       
                            d_w = d.split(' ');
                        }

                        var d_t = d;
                  
                        d_w = d_t.split(' ');
                        var data_length = Object.keys(tiles_in).length;

                        for (var i = 0; i < data_length; i++) { 

                            var score = 0;
                            var lang = 0;
                            var s_t = '';

                          
                                var no_par = d.replace(/\(|\)/g, "");
                                var pat = new RegExp(no_par, 'gi');
                                  console.log(status);
                                     if ((tiles_in[i].status.length) >= 1) {

                                        var stat = 0;
                                        for (j = 0; j < tiles_in[i].status.length; j++) {
                                            if (status === tiles_in[i].status[j]) {
                                                stat++;
                                            }
                                        }
                                    }

                                    if ( stat > 0) { 
                                       
                                        for (var x = 0; x < tiles_in[i].tags.length ; x++) {

                                          var no_par_tag = tiles_in[i].tags[x].replace(/\(|\)/g, ""); 
                                          //var new_tag = new RegExp(no_par_tag, 'gi');
                                        
                    
                                            if (no_par_tag.search(pat) != -1) {
                                                  var m_c= no_par_tag.search(pat).length;
                                                //var m_c = tiles_in[i].tags[x].match(pat).length;
                                                score += (10 * m_c);
                                                if (score != 0) {
                                                    found.push(
                                                    {
                                                        "id": tiles_in[i].id,
                                                        "title": tiles_in[i].title,
                                                        "desc": s_t,
                                                        "filename": tiles_in[i].filename,  
                                                        "icon": tiles_in[i].icon,                                                      
                                                        "tag":true
                                                    });
                                                    found_tag.push(
                                                    {
                                                        "id": tiles_in[i].id,
                                                        "title": tiles_in[i].title,
                                                        "desc": s_t,
                                                        "filename": tiles_in[i].filename,  
                                                        "icon": tiles_in[i].icon,                                                      
                                                        "tag":true
                                                    });

                                                    c++;

                                                }



                                            }
                                        }
                                        if (tiles_in[i].title.search(pat) != -1) {
                                            var m_c = tiles_in[i].title.match(pat).length;
                                            score += (20 * m_c);
                                            if (score != 0) {
                                                found.push(
                                                {
                                                    "id": tiles_in[i].id,
                                                    "title": tiles_in[i].title,
                                                    "desc": s_t,
                                                    "filename": tiles_in[i].filename,                                                    
                                                    "tag":false
                                                });

                                                found_title.push(
                                                {
                                                    "id": tiles_in[i].id,
                                                    "title": tiles_in[i].title,
                                                    "desc": s_t,
                                                    "filename": tiles_in[i].filename,                                                    
                                                    "tag":false
                                                });
                                                c++;

                                            }
                                        } 

                                        if (tiles_in[i].filename.search(pat) != -1) {
                                            score += 20;
                                        } 
                                    }
                        }
                    }
                  
                    if (c != 0) {
 

                       found_new= getUniqueValuesOfKey(found_tag.concat(found_title),'filename');

                                                  
                        var l_o = 0;
                        for (var i = 0; i < found_new.length; i++) {
                            var extn = '';
                            if (l_o >= start && l_o < set.show + start) {

                                set.newWindow=false;

                                if (found_new[i].filename.indexOf('http://') === 0 || found_new[i].filename.indexOf('https://') === 0 || found_new[i].filename.indexOf('pdf/') === 0 || found_new[i].filename.indexOf('video/') === 0) {
                              
                                    set.newWindow=true;
                              }
                              if(i==0) {
                                   out += "<div class='tipue_suggestion'>Suggestions for &#8220;" + d + "&#8221;</div>"; 
                              }
                            

                             /*if ((found_new[i].icon.trim()) === 'pdf') {
                                  out += '<div class="tipue_drop_left pdf"><div class="tipue_search_content_title"><a ' ;
                                  if(set.newWindow){
                                    out+= 'target="_blank"';
                                  }
                                  out+=  ' id ="' + found_new[i].id + '"  href="'+  found_new[i].filename + '">' + found_new[i].title + '</a></div></div>';

                              } else if ((found_new[i].icon.trim()) === 'video') {                                    
                                  out += '<div class="tipue_drop_left video"><div class="tipue_search_content_title"><a ';
                                  if(set.newWindow){
                                    out+= 'target="_blank"';
                                  }
                                  out+= 'id ="'+ found_new[i].id + '"  href="' + found_new[i].filename + '">' + found_new[i].title + '</a></div></div>';
                              }
                              else{*/


                              
                                  out += '<div class="tipue_search_content_title"><a ';
                                  if(set.newWindow){
                                    out+= 'target="_blank"';
                                  }
                                  out+= 'id ="'+ found_new[i].id + '"   href="' + found_new[i].filename + '">' + found_new[i].title + '</a></div>';
                             // }




                                if (set.debug) {
                                    out += '<div class="tipue_search_content_debug">Score: ' + found_new[i].score + '</div>';
                                }

                                if (set.showfilename) {
                                    var s_u = found_new[i].filename.toLowerCase();
                                    if (s_u.indexOf('http://') == 0) {
                                        s_u = s_u.slice(7);
                                    }                                   
                                //check icon
                                // out += '<div class="tipue_search_content_filename"> <a href="' + found[i].filename + '"' + + '>' + s_u + '</a></div>';
                                }


                                //so desc results

                                if (found_new[i].desc) {
                                    var t = found_new[i].desc;
                                    var t_d = '';
                                    var t_w = t.split(' ');
                                    if (t_w.length < set.descriptiveWords) {
                                        t_d = t;
                                    }
                                    else {
                                        for (var f = 0; f < set.descriptiveWords; f++) {
                                            t_d += t_w[f] + ' ';
                                        }
                                    }
                                    t_d = $.trim(t_d);
                                    if (t_d.charAt(t_d.length - 1) != '.') {
                                        t_d += ' ...';
                                    }
                                    out += '<div class="tipue_search_content_text">' + t_d + '</div>';
                                }
                            }
                            l_o++;
                        }

                        if (found_new.length > set.show) {

                            var pages = Math.ceil(found_new.length / set.show);

                            var page = (start / set.show);

                            out += '<div id="tipue_search_foot"><ul id="tipue_search_foot_boxes">';

                            if (start > 0) {
                                // out += '<li><a class="tipue_search_foot_box" id="' + (start - set.show) + '_' + replace + '">' + tipuesearch_string_6 + '</a></li>';
                            }

                            if (page <= 2) {
                                var p_b = pages;
                                if (pages > 3) {
                                    p_b = 3;
                                }

                                for (var f = 0; f < p_b; f++) {  
                                    out += '<li><a class="tipue_search_foot_box" id="' + (f * set.show) + '">' + (f + 1) + '</a></li>';
                                     
                                }
                            }
                            else {
                                var p_b = page + 2;
                                if (p_b > pages) {
                                    p_b = pages;
                                }
                                for (var f = page - 1; f < p_b; f++) {
                                    if (f == pages) {
                                        // out += '<li class="current">' + (f + 1) + '</li>';
                                    }
                                    else {
                                        //   out += '<li><a class="tipue_search_foot_box" id="' + (f * set.show) + '_' + replace + '">' + (f + 1) + '</a></li>';
                                    }
                                }
                            }

                            if (page + 1 != pages) {
                              //  out += '<li><a class="tipue_search_foot_box" id="' + (start + set.show) + '_' + replace + '">' + + '</a></li>';
                            }

                            out += '</ul></div>';
                        }

                    }
                    else {

                        out += '<div class="tipue_suggestion_full_page">Suggestions for “' + d +'”</div><div id="tipue_search_warning"> No Results Found. </div>';
                    }
                }else{

                }
             
                $('#myModal').addClass('in');
                $('#myModal').css('display', 'block');

                $('#myDiv').html(out);

                $('#tipue_search_replaced').click(function () {
                    getTipueSearch(0, false);
                });

                $('.tipue_search_foot_box').click(function () {
                    var id_v = $(this).attr('id');
                    var id_a = id_v.split('_');

                    getTipueSearch(parseInt(id_a[0]), id_a[1]);
                });

                eventTrackSearch();
                return false;
            }

            function eventTrackSearch(){ 

              //*search result event track*/
              $('#tipue_drop_wrapper a[href^="http"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'Outbound', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              });


              $('#tipue_drop_wrapper a[href^="video/"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'Video', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              });
              $('#tipue_drop_wrapper a[href^="https"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'Outbound', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              });

               $('#tipue_drop_wrapper a[href^="pdf/"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'PDF', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              }); 

              /* full page search result event track */
              $('#myDiv a[href^="http"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'Outbound', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              });

               $('#myDiv a[href^="https"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'Outbound', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              });

              $('#myDiv a[href^="video/"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'Video', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              });
             
               $('#myDiv a[href^="pdf/"]').each(function () {

                  // ADD GA tracking code to links
                  $(this).attr('onclick', "ga('send', 'event', 'PDF', 'Clicked', jQuery(this).attr('href'), {'nonInteraction': 1});");
                  $(this).attr('target', '_blank'); // OPTIONAL: ADD target blank
                  $(this).append('<span class="sr-only">opens in a new window</span>');
              });  

            }


        });
    };


})(jQuery);
